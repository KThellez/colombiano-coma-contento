{% extends 'base.html' %}

{% block title %}Editar Plato{% endblock %}

{% block content %}
<h1 class="title">Editar Plato</h1>

<form method="post">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="field">
    <label class="label">Nombre</label>
    <div class="control">
      <input class="input" type="text" name="nombre" value="{{ plato[1] }}" required>
    </div>
  </div>

  <div>
    <h2 class="subtitle mt-5">Agregar Ingredientes</h2>

    <div class="field">
      <label class="label">Buscar Ingrediente</label>
      <div class="control">
        <input class="input" type="text" id="buscar-ingrediente" placeholder="Ej. Sal, Arroz, Ajo...">
      </div>
    </div>

    <ul id="resultados-busqueda" class="box"></ul>

    <h3 class="subtitle mt-4">Ingredientes Seleccionados</h3>
    <table class="table is-bordered" id="ingredientes-seleccionados">
      <thead>
        <tr>
          <th>Ingrediente</th>
          <th>Cantidad</th>
          <th>Unidad</th>
          <th>Descripción</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <input type="hidden" name="ingredientes_json" id="ingredientes-json">
  </div>

  <div class="field">
    <label class="label">Descripción</label>
    <div class="control">
      <textarea class="textarea" name="descripcion">{{ plato[2] }}</textarea>
    </div>
  </div>

  <div class="field">
    <label class="label">Nivel de Complejidad</label>
    <div class="control">
      <div class="select">
        <select name="nivel_complejidad" required>
          {% for nivel in niveles_complejidad %}
          <option value="{{ nivel[0] }}" {% if plato and nivel[0] == plato[3] %}selected{% endif %}>{{ nivel[1] }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="field">
    <label class="label">Foto (URL)</label>
    <div class="control">
      <input class="input" type="text" name="foto" value="{{ plato[4] }}">
    </div>
  </div>

  <div class="field">
    <label class="label">Precio de Venta</label>
    <div class="control">
      <input class="input" type="number" step="0.01" name="precio_venta" value="{{ plato[5] }}" required>
    </div>
  </div>

  <div class="field">
    <label class="label">Región</label>
    <div class="control">
      <div class="select">
        <select name="id_region">
          {% for region in regiones %}
          <option value="{{ region[0] }}" {% if region[0] == plato[6] %}selected{% endif %}>{{ region[1] }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="field">
    <label class="label">Categoría</label>
    <div class="control">
      <div class="select">
        <select name="id_categoria">
          {% for categoria in categorias %}
          <option value="{{ categoria[0] }}" {% if categoria[0] == plato[7] %}selected{% endif %}>{{ categoria[1] }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="field is-grouped">
    <div class="control">
      <button class="button is-primary">Guardar Cambios</button>
    </div>
    <div class="control">
      <a href="{{ url_for('private_plato.listado_platos') }}" class="button is-light">Cancelar</a>
    </div>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const buscarInput = document.getElementById('buscar-ingrediente');
  const resultados = document.getElementById('resultados-busqueda');
  const tabla = document.getElementById('ingredientes-seleccionados').querySelector('tbody');
  const ingredientesInput = document.getElementById('ingredientes-json');
  let ingredientesSeleccionados = [];

  buscarInput.addEventListener('input', async () => {
    const query = buscarInput.value.trim();
    resultados.innerHTML = '';
    if (query.length < 2) return;

    const res = await fetch(`/admin/ingredientes/api/ingredientes?q=${query}`);
    const data = await res.json();

    data.forEach(ing => {
      const item = document.createElement('li');
      item.textContent = `${ing.nombre} (${ing.unidad})`;
      item.classList.add('is-clickable');
      item.setAttribute('draggable', 'true');
      item.dataset.ingrediente = JSON.stringify(ing);

      item.addEventListener('click', () => {
        agregarIngrediente(ing);
        resultados.innerHTML = '';
        buscarInput.value = '';
      });

      item.addEventListener('dragstart', e => {
        e.dataTransfer.setData('application/json', item.dataset.ingrediente);
      });

      resultados.appendChild(item);
    });
  });

  tabla.parentElement.addEventListener('dragover', e => {
    e.preventDefault();
  });

  tabla.parentElement.addEventListener('drop', e => {
    e.preventDefault();
    const data = e.dataTransfer.getData('application/json');
    if (data) {
      const ingrediente = JSON.parse(data);
      agregarIngrediente(ingrediente);
    }
  });

  function agregarIngrediente(ingrediente, cantidad = 1, descripcion = '') {
    if (ingredientesSeleccionados.find(i => i.id_ingrediente === ingrediente.id_ingrediente)) return;

    const tr = document.createElement('tr');
    tr.id = `ingrediente-fila-${ingrediente.id_ingrediente}`;
    tr.innerHTML = `
      <td>${ingrediente.nombre}</td>
      <td><input type="number" step="0.1" min="0.1" value="${cantidad}" class="input cantidad"></td>
      <td>${ingrediente.unidad}</td>
      <td><input type="text" class="input descripcion" value="${descripcion}"></td>
      <td><button class="button is-small is-danger">Quitar</button></td>
    `;

    tr.querySelector('button').addEventListener('click', () => {
      quitarIngrediente(ingrediente.id_ingrediente);
    });

    tabla.appendChild(tr);
    ingredientesSeleccionados.push({ ...ingrediente });
    actualizarJSON();
  }

  function quitarIngrediente(id_ingrediente) {
    ingredientesSeleccionados = ingredientesSeleccionados.filter(i => i.id_ingrediente !== id_ingrediente);
    const fila = document.getElementById(`ingrediente-fila-${id_ingrediente}`);
    if (fila) fila.remove();
    actualizarJSON();
  }

  function actualizarJSON() {
    const rows = tabla.querySelectorAll('tr');
    const datos = Array.from(rows).map((row, index) => ({
      id_ingrediente: ingredientesSeleccionados[index].id_ingrediente,
      cantidad: parseFloat(row.querySelector('.cantidad').value),
      descripcion: row.querySelector('.descripcion').value
    }));
    ingredientesInput.value = JSON.stringify(datos);
  }

  // Inicializar ingredientes existentes desde Flask
  const ingredientesIniciales = {{ ingredientes_existentes | tojson }};
  ingredientesIniciales.forEach(ing => {
    agregarIngrediente(ing, ing.cantidad, ing.breve_descripcion);
  });
});
</script>

{% endblock %}
